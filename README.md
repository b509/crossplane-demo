# Crossplane Demo

## Regenerate Certs (Optional) 
```
./registry/certs/generateCerts.sh
```

## Create k3d Cluster
```
sudo k3d cluster create crossplane-demo \
--volume "$(pwd)/registry/registries.yaml:/etc/rancher/k3s/registries.yaml" \
--volume "$(pwd)/registry/certs/self-signed-ca.crt:/etc/ssl/certs/self-signed-ca.crt" \
-p "80:80@loadbalancer" \
-p "443:443@loadbalancer" \
-p "7233:7233@loadbalancer"

sudo k3d kubeconfig merge crossplane-demo --kubeconfig-switch-context -o ~/.kube/config

USERNAME=$(whoami) && sudo chown ${USERNAME}:${USERNAME} ~/.kube/config 
```

## DNS
Many Linux distributions ships with NSS-myhostname, which resolves *.localhost

If not install `nss-myhostname` 
```
sudo apt install libnss-myhostname
```

If not possbile you have to add /etc/hots entries pointing to 127.0.0.1 manually

## Selfhosted Registry
We can not utilize K3d's build-in registry (`--create-registry`), because we need SSL.
Furthermore we can also not use build-in image upload mechanism (`k3d image import`), because crossplane needs an OCI compatible registry to pull from.


Start selfhosted registry 
```
sudo docker-compose up -d [--build]
```

Connect Cluster to selfhosted registry 
```
sudo docker network connect k3d-crossplane-demo registry.k3d.localhost
```

Get Ip of Registry
```
sudo docker inspect registry.k3d.localhost | jq -r '.[0].NetworkSettings.Networks."k3d-crossplane-demo".IPAddress'
```

Modify coredns configmap 
```
kubectl edit cm -n kube-system coredns
```

by adding entry: 
```
<IpOfRegistry> registry.k3d.localhost
```

restart codedns pod
```
export POD=$(kubectl get pods --no-headers -o custom-columns=':metadata.name' -n kube-system | grep coredns | cat); kubectl delete pod -n kube-system  $POD

```


# Crossplane
https://docs.crossplane.io/latest/software/install/

## Install via Helm
```
helm repo add crossplane-stable https://charts.crossplane.io/stable
helm repo update
```

```
helm install crossplane \
--namespace crossplane-system \
--create-namespace crossplane-stable/crossplane \
--set registryCaBundleConfig.name=ca-bundle-config,registryCaBundleConfig.key=ca-bundle
```

Create configmap to trust private registry with selfsigned cert
```
kubectl -n crossplane-system create cm ca-bundle-config \
--from-file=ca-bundle=./registry/certs/self-signed-ca.crt
```

# Crossplane UI

## Install via Helm
```
helm repo add komodorio https://helm-charts.komodor.io 
helm repo update  
helm install komoplane komodorio/komoplane \
--set "ingress.enabled=true,ingress.hosts[0].host=komoplane.k8s.localhost,ingress.hosts[0].paths[0].path=/,ingress.hosts[0].paths[0].pathType=ImplementationSpecific"
```

Crossplane UI URL: http://komoplane.k8s.localhost/

# Testing with Grafana
## Install Grafana via Helm
https://github.com/grafana/helm-charts/blob/main/charts/grafana/README.md


```
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
helm install my-release grafana/grafana --set "adminUser=admin,adminPassword=password,ingress.enabled=true,ingress.hosts[0]=grafana.k8s.localhost"
```

## Install Crossplane Grafana Provider
[Grafana Provider](https://marketplace.upbound.io/providers/grafana/provider-grafana/v0.8.0) was generated by [upjet](https://github.com/upbound/upjet).

Therefore Provider configuration (Kind:ProviderConfig.spec.credentials) can be inferred by:
https://registry.terraform.io/providers/grafana/grafana/latest/docs#schema

```
kubectl apply -f ./k8s/crossplane/grafana
```

## Check

Grafana URL: http://grafana.k8s.localhost/


# Test with Temporal
## Install Temporal via Helm
```
git clone https://github.com/temporalio/helm-charts
cd helm-charts

helm dependencies update

helm install --set "server.replicaCount=1,cassandra.config.cluster_size=1,prometheus.enabled=false,grafana.enabled=false,elasticsearch.enabled=false,web.ingress.enabled=true,web.ingress.hosts[0]=temporal.k8s.localhost,server.frontend.service.type=LoadBalancer" temporaltest . --timeout 15m
```

## Build Crossplane Temporal Provider
```
git clone https://github.com/denniskniep/provider-temporal.git
make build
```

copy output from `/provider-temporal/_output/xpkg/linux_amd64/*.xpkg` to `/crossplane-demo/registry/files/provider-temporal.xpkg`
```
cp ../provider-temporal/_output/xpkg/linux_amd64/*.xpkg registry/files/provider-temporal.xpkg
```

## Push *.xpkg file 
Build container with crossplane cli
```
sudo docker build -t "crossplane-cli:latest" -f ./registry/Dockerfile.crossplane-cli ./registry


Start container with crossplane cli + trusted self signed cert
```
sudo docker run --rm -it --net=host -v $(pwd)/registry/files:/files crossplane-cli:latest bash
```

push file to OCI registry (The file was built with `make build` in source repo)
```
crossplane xpkg push -f /files/provider-temporal.xpkg registry.k3d.localhost:5000/provider-temporal:v0.0.1-dirty
```


## Install Crossplane Temporal Provider
```
kubectl apply -f ./k8s/crossplane/temporal
```

## Check

Temporal URL: http://temporal.k8s.localhost/namespaces

Query namespaces with CLI
```
temporal operator namespace list --address temporal.k8s.localhost:7233
```
